from flask import Flask, render_template, send_from_directory, url_for
import os
import json
from pathlib import Path

app = Flask(__name__)

# Paths
PLOTS_DIR = "/darrays/qc-working/images"

# Load station names (pretty names)
SITE_JSON = Path("stations.json")
SITE_NAMES = {}
if SITE_JSON.exists():
    with SITE_JSON.open() as f:
        SITE_NAMES = json.load(f)

# Load station metadata (coords + channels)
META_JSON = Path("stations_meta.json")
STATIONS_META = {}
if META_JSON.exists():
    with META_JSON.open() as f:
        STATIONS_META = json.load(f)

# Plot order
PLOT_ORDER = ["week", "two_weeks", "month", "year", "full"]


# --- Helpers ------------------------------------------------
def get_site_name(network, station):
    return SITE_NAMES.get(network, {}).get(station, station)
        for file in files:
            if file.lower() in preferred:
                return url_for(
                    "serve_plot",
                    filename=os.path.relpath(os.path.join(root, file), PLOTS_DIR),
                )
        for file in files:
            if file.lower().endswith((".jpg", ".png")):
                return url_for(
                    "serve_plot",
                    filename=os.path.relpath(os.path.join(root, file), PLOTS_DIR),
                )
    return None

# --- Routes ------------------------------------------------
# Custom sort order
CUSTOM_ORDER = ["HL", "HT", "HP", "HA", "HC", "CQ", "ME", "1Y", "HI", "EG", "5B", "KF"]

def sort_networks(networks):
    return sorted(
        networks,
        key=lambda net: (
            CUSTOM_ORDER.index(net) if net in CUSTOM_ORDER else 9999,
            net  # secondary alphabetical sort
        )
    )


@app.route("/")
def index():
    """Main page: list networks with thumbnails"""

    # original network list
    networks = [
        d for d in os.listdir(PLOTS_DIR)
        if os.path.isdir(os.path.join(PLOTS_DIR, d))
    ]

    # APPLY CUSTOM SORT ORDER
    networks = sort_networks(networks)

    network_cards = []
    for net in networks:
        net_path = os.path.join(PLOTS_DIR, net)
        thumb = find_thumbnail(net_path)
        if thumb:  # only show networks with plots
            network_cards.append((net, thumb))

    return render_template("index.html", networks=network_cards)

@app.route("/psds/<network>")
def network_page(network):
    """Network page: list stations with thumbnails and site names"""
    net_path = os.path.join(PLOTS_DIR, network)
    if not os.path.exists(net_path):
        return f"Network {network} not found", 404

    stations = sorted(
        [d for d in os.listdir(net_path) if os.path.isdir(os.path.join(net_path, d))]
    )

    station_cards = []
    for sta in stations:
        sta_path = os.path.join(net_path, sta)
        thumb = find_thumbnail(sta_path)
        site_name = get_site_name(network, sta)
        if thumb:  # only show stations with plots
            station_cards.append((sta, thumb, site_name))

    return render_template("network.html", network=network, stations=station_cards)


@app.route("/psds/<network>/<station>")
def station_page(network, station):
    """Station page: show available channels as links"""
    sta_path = os.path.join(PLOTS_DIR, network, station)
    if not os.path.exists(sta_path):
        return f"Station {station} not found in {network}", 404

    channels = sorted(
        [d for d in os.listdir(sta_path) if os.path.isdir(os.path.join(sta_path, d))]
    )

    station_data = {}
    for chan in channels:
        chan_path = os.path.join(sta_path, chan)
        plots = {}
        for file in os.listdir(chan_path):
            if file.lower().endswith((".jpg", ".png")):
                plot_name = os.path.splitext(file)[0]
                plots[plot_name] = url_for(
                    "serve_plot", filename=f"{network}/{station}/{chan}/{file}"
                )
        if plots:
            station_data[chan] = plots

    site_name = get_site_name(network, station)

    return render_template(
        "station.html",
        network=network,
        station=station,
        station_data=station_data,
        site_name=site_name,
        no_plots=(len(station_data) == 0),
    )


@app.route("/psds/<network>/<station>/<channel>")
def channel_page(network, station, channel):
    """Channel page: show all plots for a single channel"""
    chan_path = os.path.join(PLOTS_DIR, network, station, channel)
    if not os.path.exists(chan_path):
        return f"Channel {channel} not found in {network}.{station}", 404

    plots = {}
    for file in os.listdir(chan_path):
        if file.lower().endswith((".jpg", ".png")):
            plot_name = os.path.splitext(file)[0]
            plots[plot_name] = url_for(
                "serve_plot", filename=f"{network}/{station}/{channel}/{file}"
            )

    ordered = {k: plots[k] for k in PLOT_ORDER if k in plots}
    for k in sorted(plots):
        if k not in ordered:
            ordered[k] = plots[k]

    site_name = get_site_name(network, station)

    # Merge metadata if available
    meta_key = f"{network}.{station}"
    meta = STATIONS_META.get(meta_key, {})

    return render_template(
        "channel.html",
        network=network,
        station=station,
        channel=channel,
        plots=ordered,
        site_name=site_name,
        no_plots=(len(ordered) == 0),
        meta=meta,
    )


@app.route("/plots/<path:filename>")
def serve_plot(filename):
    """Serve static images"""
    return send_from_directory(PLOTS_DIR, filename)


@app.route("/map")
def map_page():
    """Map page: show all stations with coordinates"""
    stations = []

    for key, meta in STATIONS_META.items():
        stations.append({
            "network": meta.get("network"),
            "station": meta.get("station"),
            "latitude": meta.get("latitude"),
            "longitude": meta.get("longitude"),
            "site_name": meta.get("site_name", f"{meta.get('network')}.{meta.get('station')}"),
            "elevation": meta.get("elevation"),
            "channels": meta.get("channels", [])
        })

    return render_template("map.html", stations=stations)


# --- Main ---------------------------------------------------
if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
