{% extends "base.html" %}
{% block title %}{{ network }}.{{ station }}.{{ channel }}{% endblock %}
{% block content %}

<!-- Channel Header -->
<div class="mb-8 bg-white p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold">
    {{ network }}.{{ station }}.{{ channel }}
    {% if site_name %}  {{ site_name }}{% endif %}
  </h1>

  {% if meta %}
    <p class="text-gray-600 mt-2">
      Lat: {{ meta.latitude }}, Lon: {{ meta.longitude }},
      Elev: {{ meta.elevation }} m
    </p>
  {% endif %}
</div>

{% if no_plots %}
  <div class="bg-yellow-100 text-yellow-800 p-4 rounded">
    No plots available for this channel.
  </div>
{% else %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for plot, url in plots.items() %}
      <div
        class="plot-card bg-white rounded-lg shadow hover:shadow-lg transition cursor-pointer overflow-hidden"
        data-url="{{ url }}"
        data-plot="{{ plot }}"
        data-channel="{{ channel }}"
        title="{{ channel }} {{ plot.replace('_',' ') }}"
      >
        <img src="{{ url }}" alt="{{ plot }}" class="w-full h-64 object-contain">
        <div class="p-3 text-center">
          <h3 class="text-md font-medium text-gray-800 capitalize">
            {{ plot.replace("_"," ") }}
          </h3>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="mt-10 space-x-4">
  <a href="{{ url_for('station_page', network=network, station=station) }}"
     class="text-indigo-600 hover:underline">Back to Station</a>
  <a href="{{ url_for('network_page', network=network) }}"
     class="text-indigo-600 hover:underline">Back to Network</a>
</div>

<!-- Lightbox Modal -->
<div id="imageModal"
     class="fixed inset-0 bg-black/90 hidden z-50 grid grid-rows-[1fr_auto] place-items-center">
  <!-- Close button -->
  <button type="button"
          class="absolute top-4 right-6 text-white text-3xl leading-none"
          aria-label="Close"
          id="closeBtn">&times;</button>

  <!-- Prev / Next buttons -->
  <button type="button" id="prevBtn"
          class="absolute left-4 md:left-8 top-1/2 -translate-y-1/2 text-white text-4xl px-3 py-1 rounded hover:bg-white/10"
          aria-label="Previous">&#10094;</button>
  <button type="button" id="nextBtn"
          class="absolute right-4 md:right-8 top-1/2 -translate-y-1/2 text-white text-4xl px-3 py-1 rounded hover:bg-white/10"
          aria-label="Next">&#10095;</button>

  <!-- Image -->
  <img id="modalImg" src="" class="max-h-[80vh] max-w-[90vw] rounded-lg shadow-2xl mb-4 select-none" alt="plot">

  <!-- Title -->
  <div id="modalTitle" class="text-white text-lg font-semibold pb-8"></div>
</div>

<script>
  let images = [];
  let currentIndex = 0;

  const modal      = document.getElementById('imageModal');
  const modalImg   = document.getElementById('modalImg');
  const modalTitle = document.getElementById('modalTitle');
  const closeBtn   = document.getElementById('closeBtn');
  const prevBtn    = document.getElementById('prevBtn');
  const nextBtn    = document.getElementById('nextBtn');

  function buildImageList() {
    images = Array.from(document.querySelectorAll('.plot-card')).map(el => ({
      url: el.dataset.url,
      plot: el.dataset.plot,
      channel: el.dataset.channel
    }));
  }

  function openImageAt(index) {
    if (!images.length) buildImageList();
    currentIndex = Math.max(0, Math.min(index, images.length - 1));
    showImage(currentIndex);
    modal.classList.remove('hidden');
  }

  function showImage(idx) {
    const img = images[idx];
    modalImg.src = img.url;
    modalTitle.textContent = `${img.channel}  ${img.plot.replaceAll('_', ' ')}`;
  }

  function closeImage() {
    modal.classList.add('hidden');
  }

  function nextImage() {
    if (!images.length) return;
    currentIndex = (currentIndex + 1) % images.length;
    showImage(currentIndex);
  }

  function prevImage() {
    if (!images.length) return;
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    showImage(currentIndex);
  }

  // Hook up all cards
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.plot-card').forEach((el, idx) => {
      el.addEventListener('click', () => openImageAt(idx));
    });
  });

  // Buttons
  closeBtn.addEventListener('click', closeImage);
  nextBtn.addEventListener('click', nextImage);
  prevBtn.addEventListener('click', prevImage);

  // Backdrop click closes
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeImage();
  });

  // Keyboard controls
  window.addEventListener('keydown', (e) => {
    if (modal.classList.contains('hidden')) return;
    if (e.key === 'Escape') closeImage();
    else if (e.key === 'ArrowRight') nextImage();
    else if (e.key === 'ArrowLeft') prevImage();
  });
</script>

{% endblock %}
