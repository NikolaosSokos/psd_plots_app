{% extends "base.html" %}
{% block title %}Station Map{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">Station Map</h1>

<div id="map" class="w-full h-[600px] rounded-lg shadow"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const stations = {{ stations|tojson }};

  const map = L.map('map').setView([38.0, 23.7], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  stations.forEach(st => {
    if (!st.latitude || !st.longitude) return;

    let channelsList = "";
    if (st.channels && st.channels.length > 0) {
      channelsList = "<ul>" + st.channels.map(
        c => `<li>${c.location}.${c.code} (since ${c.start_date})</li>`
      ).join("") + "</ul>";
    }

    const popupContent = `
      <div class="text-sm">
        <strong>${st.network}.${st.station}</strong><br/>
        ${st.site_name || ""}<br/>
        Elevation: ${st.elevation || "N/A"} m<br/>
        <a href="/psds/${st.network}/${st.station}" class="text-indigo-600 underline">View PSD plots</a>
        ${channelsList}
      </div>
    `;

    L.marker([st.latitude, st.longitude])
      .addTo(map)
      .bindPopup(popupContent);
  });
</script>
{% endblock %}
